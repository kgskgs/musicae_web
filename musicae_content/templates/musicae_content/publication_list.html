{% extends "musicae_base/base.html" %}
{% load i18n url_i18n static %}

{% block head_extra %}

  <title>{% trans "Библиотека" %} | Fundamenta Musicae</title>
  <link rel="canonical" href="{% url 'library_lst' %}">
  <link rel="alternate" href="{{ request.get_full_path|translate_url:'bg' }}" hreflang="bg">
  <link rel="alternate" href="{{ request.get_full_path|translate_url:'en' }}" hreflang="en">
  <link rel="alternate" href="{{ request.get_full_path|translate_url:'de' }}" hreflang="de">

  <meta name="description" content="{% trans 'Публикации от членовете на Fundamenta Musicae — статии, книги, изследвания.' %}">
  <meta property="og:type" content="website">
  <meta property="og:title" content="{% trans 'Библиотека | Fundamenta Musicae' %}">
  <meta property="og:description" content="{% trans 'Разгледайте и свалете публикации от нашия колектив.' %}">
  <meta property="og:url" content="{% url 'library_lst' %}">
  <meta property="og:image" content="{{ STATIC_URL }}musicae_base/og/library.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{% trans 'Библиотека | Fundamenta Musicae' %}">
  <meta name="twitter:description" content="{% trans 'Разгледайте и свалете публикации от нашия колектив.' %}">

  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"CollectionPage",
  "name":"{% filter escapejs %}{% trans 'Библиотека | Fundamenta Musicae' %}{% endfilter %}",
  "url":"{% url 'library_lst' %}"}
  </script>

  <script src="{% static 'musicae_content/publication_list.js' %}"></script>
  <script>
  // Simple client-side sorter for the publication list
  (function () {
    document.addEventListener('DOMContentLoaded', function () {
      const list = document.querySelector('.publication-list');
      if (!list) return;

      const controls = document.getElementById('sort-controls');
      const buttons = controls ? Array.from(controls.querySelectorAll('.btn-sort')) : [];
      const originalItems = Array.from(list.querySelectorAll('.publication-item'));

      // Default: sort by year DESC on load
      let currentKey = 'year';
      let ascending = false;
      sortAndRender(currentKey, ascending);

      // Wire up buttons
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.sort;

          // Toggle order if clicking the same key; otherwise pick default order
          if (currentKey === key) {
            ascending = !ascending;
          } else {
            currentKey = key;
            ascending = key === 'year' ? false : true;
          }

          // Visual state
          buttons.forEach((b) => {
            b.classList.remove('ring-2', 'ring-indigo-500', 'bg-gray-50');
            b.setAttribute('aria-pressed', 'false');
            const arr = b.querySelector('.sort-arrow');
            if (arr) arr.remove();
          });
          btn.classList.add('ring-2', 'ring-indigo-500', 'bg-gray-50');
          btn.setAttribute('aria-pressed', 'true');
          const arrow = document.createElement('span');
          arrow.className = 'sort-arrow ml-1';
          arrow.textContent = ascending ? '↑' : '↓';
          btn.appendChild(arrow);

          sortAndRender(currentKey, ascending);
        });
      });

      function sortAndRender(key, asc) {
        const items = Array.from(list.querySelectorAll('.publication-item'));
        const sorted = items.sort((a, b) => compare(a, b, key, asc));
        sorted.forEach((el) => list.appendChild(el)); // Re-append in sorted order
      }

      function compare(aEl, bEl, key, asc) {
        let a = aEl.dataset[key] ?? '';
        let b = bEl.dataset[key] ?? '';

        if (key === 'year') {
          const ai = parseInt(a, 10) || 0;
          const bi = parseInt(b, 10) || 0;
          return asc ? ai - bi : bi - ai;
        }

        const cmp = a.localeCompare(b, undefined, { sensitivity: 'base' });
        return asc ? cmp : -cmp;
      }
    });
  })();
  </script>

  {# ✅ Add this style block below your script #}
  <style>
    /* Thin right stripe for visual accent */
    body::after {
      content: "";
      position: fixed;
      top: 0;
      right: 0;
      width: 6px; /* thickness of the stripe */
      height: 100vh;
      background-color: var(--color-surface);
      z-index: 50;
      pointer-events: none; /* prevent blocking clicks */
    }
  </style>
{% endblock head_extra %}



{% block content %}


<div class="max-w-6xl mx-auto px-4 py-8 md:py-12">

 <h2 class="text-h2 font-display mb-4" data-i18n="h2_library">
  {% trans "Библиотека" %}
</h2>

<!-- Sort controls -->
<div id="sort-controls" class="mb-8 flex flex-wrap items-center gap-2 text-sm">
  <span class="text-gray-600">{% trans "Подреди по:" %}</span>

  <button type="button"
          class="btn-sort px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500"
          data-sort="year"
          data-order="desc"
          aria-pressed="true">
    {% trans "Дата" %} <span class="sort-arrow ml-1">↓</span>
  </button>

  <button type="button"
          class="btn-sort px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500"
          data-sort="type"
          data-order="asc">
    {% trans "Тип" %}
  </button>

  <button type="button"
          class="btn-sort px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500"
          data-sort="title"
          data-order="asc">
    {% trans "Име" %}
  </button>
</div>

<ul class="publication-list mt-4">
  {% for publication in publications %}
    <li class="publication-item"
        data-year="{{ publication.published_year|default:0 }}"
        data-type="{{ publication.get_ptype_display|lower }}"
        data-title="{{ publication.title|lower }}">
      <p class="pub-meta">{{ publication.get_ptype_display }} / {{ publication.published_year }}</p>

      <a href="{{ publication.get_absolute_url }}" class="pub-title">
        {{ publication.title }}
      </a>

      <p class="text-body pub-bib">
        <span class="text-lg text-gray-600">
          {% for member in publication.authors.all %}
            <a href="{% url 'members_det' member.pk %}"
               class="text-gray-700 hover:text-indigo-600 hover:underline underline-offset-2 transition-colors duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 rounded-sm">
              {{ member.name }}
            </a>{% if not forloop.last %},{% endif %}
          {% endfor %}
        </span>
        <br>
      </p>

      {% if publication.abstract %}
      <details class="pub-abstract">
        <summary class="pub-abstract-toggle">{% trans "Show Abstract" %}</summary>
        <p class="text-body">{{ publication.abstract|safe }}</p>
      </details>
      {% endif %}
    </li>
  {% empty %}
    <li class="text-body">{% trans "Няма намерени публикации" %}</li>
  {% endfor %}
</ul>


</div>



{% endblock content %}

