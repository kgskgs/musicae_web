{% load static i18n url_i18n %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'bg' }}">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Fundamenta Musicae | Center for Musical Philosophy and Humanities{% endblock %}</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&family=Inter:wght@400;700&display=swap" rel="stylesheet">

 <!-- Splide CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css" />

  <!-- Your site CSS -->
  <link rel="stylesheet" href="{% static 'musicae_base/main.css' %}" />

  <!-- Minimal fixes that preserve desktop structure -->
  <style>
    /* 1) Ensure vertical stacking by default (desktop unaffected) */
    html, body { block-size: 100%; }
    body { display: block; }
    header, main, footer { display: block; inline-size: 100%; }

    /* If some wrapper is flex on small screens, force column only below md */
    @media (max-width: 767.98px) {
      body > .flex { flex-direction: column !important; }
      .layout { flex-direction: column !important; }
      .layout > * { min-width: 0; }
    }
    

    /* 2) Mobile menu panel visibility (toggled by your JS via .visible) */
    #mobile-menu-panel {
      display: none;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: saturate(140%) blur(6px);
    }
    #mobile-menu-panel.visible { display: flex; }

    /* Optional: nicer <details> summary in mobile submenu */
    #mobile-menu-panel details.mobile-collapsible > summary {
      list-style: none;
      cursor: pointer;
    }
    #mobile-menu-panel details.mobile-collapsible > summary::-webkit-details-marker { display: none; }
    #mobile-menu-panel details[open] summary svg { transform: rotate(180deg); transition: transform .2s ease; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { scroll-behavior: auto !important; transition: none !important; animation: none !important; }
    }

  </style>

  {% block head_extra %}{% endblock %}
</head>
<body class="antialiased">

  <!-- FIXED HEADER / NAVIGATION -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60">
  <div class="container header-row">
    <a class="brand anchor-link" href="{% url 'home' %}">
      <span class="brand__name">Fundamenta Musicae</span>
    </a>

      <!-- Desktop Navigation (UNCHANGED) -->
      <nav aria-label="{% trans 'Main navigation' %}" class="hidden md:block">
      <ul class="nav-links">
          <li><a id="nav-about" class="nav-link btn anchor-link" href="{% url 'home' %}">{% trans "Начало" %}</a></li>
          <li class="relative group">
            <a id="nav-about"
               class="nav-link btn anchor-link {% if request.resolver_match.url_name == 'about' or request.resolver_match.url_name == 'about_detail' %}is-active{% endif %}"
               href="{% url 'about' %}">
              {% trans "За нас" %}
            </a>

            {% if about_children %}
              <ul class="dropdown">
                {% for rp in about_children %}
                  <li>
                    <a href="{% url 'about_detail' rp.slug %}" class="dropdown-link">
                      {{ rp.name }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </li>
           <li><a id="nav-members" class="nav-link btn anchor-link" href="{% url 'members_lst' %}">{% trans "Членове" %}</a></li>
          <li><a id="nav-library" class="nav-link btn anchor-link" href="{% url 'library_lst' %}">{% trans "Библиотека" %}</a></li>
        <!-- Language Switcher -->
          <li class="lang" id="lang-switcher">
            <a class="lang-link" href="{{ request.get_full_path|translate_url:'bg' }}"
              {% if LANGUAGE_CODE|lower == 'bg' %}aria-current="page"{% endif %}>BG</a>
            <span>&nbsp;|&nbsp;</span>
            <a class="lang-link" href="{{ request.get_full_path|translate_url:'en' }}"
              {% if LANGUAGE_CODE|lower == 'en' %}aria-current="page"{% endif %}>EN</a>
            <span>&nbsp;|&nbsp;</span>
            <a class="lang-link" href="{{ request.get_full_path|translate_url:'de' }}"
              {% if LANGUAGE_CODE|lower == 'de' %}aria-current="page"{% endif %}>DE</a>
          </li>
        </ul>
      </nav>

      <!-- Mobile Menu Button (UNCHANGED) -->
      <button id="mobile-menu-toggle"
        class="md:hidden btn-contrast p-2 rounded-lg -mr-2"
        aria-label="{% trans 'Open menu' %}">
        <svg id="menu-icon-open" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg id="menu-icon-close" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Mobile Menu Panel (REWRITTEN to mirror desktop) -->
  <div id="mobile-menu-panel" class="fixed inset-0 z-40 p-6 flex-col md:hidden">
    <nav id="mobile-menu-links" aria-label="{% trans 'Mobile navigation' %}" class="space-y-3">
      <!-- Начало -->
      <a id="mobile-nav-home" class="nav-link btn anchor-link" href="{% url 'home' %}">
        {% trans "Начало" %}
      </a>

      <!-- За нас (+ children if present) -->
      {% if about_children %}
        <details class="mobile-collapsible">
          <summary class="nav-link btn flex items-center justify-between">
            <span>{% trans "За нас" %}</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
            </svg>
          </summary>
          <ul class="pl-4 mt-2 space-y-2">
            <li>
              <a id="mobile-nav-about" href="{% url 'about' %}"
                 class="dropdown-link anchor-link {% if request.resolver_match.url_name == 'about' %}is-active{% endif %}">
                {% trans "Преглед" %}
              </a>
            </li>
            {% for rp in about_children %}
              <li>
                <a href="{% url 'about_detail' rp.slug %}"
                   class="dropdown-link anchor-link {% if request.resolver_match.url_name == 'about_detail' and request.resolver_match.kwargs.slug == rp.slug %}is-active{% endif %}">
                  {{ rp.name }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </details>
      {% else %}
        <a id="mobile-nav-about" class="nav-link btn anchor-link {% if request.resolver_match.url_name == 'about' or request.resolver_match.url_name == 'about_detail' %}is-active{% endif %}" href="{% url 'about' %}">
          {% trans "За нас" %}
        </a>
      {% endif %}

      <!-- Sections -->
      <a id="mobile-nav-members" class="nav-link btn anchor-link" href="{% url 'members_lst' %}">{% trans "Членове" %}</a>
      <a id="mobile-nav-library" class="nav-link btn anchor-link" href="{% url 'library_lst' %}">{% trans "Библиотека" %}</a>
    </nav>

    <!-- Mobile Language Switcher (link-based to auto-close via your JS) -->
    <div class="lang mt-6" id="mobile-lang-switcher" aria-label="{% trans 'Language' %}">
      <a class="lang-link" href="{{ request.get_full_path|translate_url:'bg' }}"
         {% if LANGUAGE_CODE|lower == 'bg' %}aria-current="page"{% endif %}>BG</a>
      <span>&nbsp;|&nbsp;</span>
      <a class="lang-link" href="{{ request.get_full_path|translate_url:'en' }}"
         {% if LANGUAGE_CODE|lower == 'en' %}aria-current="page"{% endif %}>EN</a>
      <span>&nbsp;|&nbsp;</span>
      <a class="lang-link" href="{{ request.get_full_path|translate_url:'de' }}"
         {% if LANGUAGE_CODE|lower == 'de' %}aria-current="page"{% endif %}>DE</a>
    </div>
  </div>

  <main class="w-full">
    {% block content %}{% endblock %}
  </main>

  <footer class="p-6 text-center text-gray-500 text-sm border-t border-gray-200 bg-white">
    © {% now "Y" %} Fundamenta Musicae. {% trans "Всички права запазени." %}
  </footer>

  <!-- Base JS (shared across pages; no Splide init here) -->
  <script type="module">
    // Pick and expose a theme globally so child templates can re-use it.
    const themes = ['ch-theme-black','ch-theme-green','ch-theme-lila','ch-theme-yellow','ch-theme-blue','ch-theme-orange'];
    const chosen = themes[Math.floor(Math.random()*themes.length)];
    window.__chThemeChosen = chosen;

    // Scroll-Triggered Kinetic Effect
    const applyScrollKinetic = () => {
      if (!('IntersectionObserver' in window)) return;
      const sections = document.querySelectorAll('.kinetic-reveal');
      sections.forEach(s => s.classList.remove('visible'));
      const obs = new IntersectionObserver((entries) => {
        entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
      }, { root: null, rootMargin: '0px', threshold: 0.1 });
      sections.forEach((section, index) => {
        const delay = section.dataset.delay || (index % 3) * 0.1;
        section.style.setProperty('--delay', `${delay}s`);
        obs.observe(section);
      });
    };

    // Mobile Menu Toggle
    const setupMobileMenu = () => {
      const toggleBtn = document.getElementById('mobile-menu-toggle');
      const menuPanel = document.getElementById('mobile-menu-panel');
      const iconOpen = document.getElementById('menu-icon-open');
      const iconClose = document.getElementById('menu-icon-close');

      const toggleMenu = (forceClose = false) => {
        const isVisible = menuPanel.classList.contains('visible');
        if (forceClose || isVisible) {
          menuPanel.classList.remove('visible');
          iconOpen.classList.remove('hidden');
          iconClose.classList.add('hidden');
          document.body.style.overflow = '';
        } else {
          menuPanel.classList.add('visible');
          iconOpen.classList.add('hidden');
          iconClose.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      };

      toggleBtn?.addEventListener('click', () => toggleMenu());
      menuPanel?.addEventListener('click', (e) => {
        if (e.target.classList.contains('anchor-link') || e.target.closest('.lang-link')) toggleMenu(true);
      });
    };

    // Smooth scroll with header offset
    const setupSmoothAnchors = () => {
      document.body.addEventListener('click', function(e) {
        const link = e.target.closest('.anchor-link');
        if (!link) return;
        const href = link.getAttribute('href');
        if (!href || !href.startsWith('#')) return;
        e.preventDefault();
        const targetId = href.substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          const headerOffset = 96; // --header-height
          const elementPosition = target.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
          window.scrollTo({ top: offsetPosition, behavior: "smooth" });
        }
      });
    };

    window.addEventListener('load', () => {
      document.body?.setAttribute('data-theme', chosen);        // ← add this
      document.querySelector('header')?.setAttribute('data-theme', chosen);
      applyScrollKinetic();
      setupMobileMenu();
      setupSmoothAnchors();
    });
  </script>

  {% block scripts %}
  <!-- Home-only JS: Splide + theme for hero + slider init -->
  <script type="module">
  import Splide from 'https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.esm.js';

  function initSmartSplide(root, perPage = 3) {
    if (!root) return;

    const list  = root.querySelector('.splide__list');
    const count = list ? list.children.length : 0;

    // Base config (no duplication here)
    const base = {
      gap: '1.5rem',
      perPage,
      perMove: 1,
      breakpoints: { 1024: { perPage: 2 }, 768: { perPage: 1 } },
    };

    // Decide behavior based on how many slides we actually have
    const options =
      count <= 1
        ? { ...base, type: 'slide', perPage: 1, arrows: false, pagination: false, drag: false }
      : count <= perPage
        ? { ...base, type: 'slide', perPage: Math.min(count, perPage), arrows: true, pagination: false }
        : { ...base, type: 'loop', arrows: true, pagination: true };

    new Splide(root, options).mount();
  }

  window.addEventListener('load', () => {
    // Keep your theme line
    const theme = window.__chThemeChosen || 'ch-theme-black';
    document.getElementById('hero')?.setAttribute('data-theme', theme);

    // Publications
    initSmartSplide(document.getElementById('publications-slider'), 3);

    // Members
    initSmartSplide(document.getElementById('members-slider'), 3);
  });
</script>

<script>
  (function () {
    function syncStripeHeight() {
      var header = document.querySelector('header');
      var stripe = document.getElementById('authors');
      if (!header || !stripe) return;
      // Match the header’s visual height
      stripe.style.minHeight = header.offsetHeight + 'px';
    }
    document.addEventListener('DOMContentLoaded', syncStripeHeight);
    window.addEventListener('resize', syncStripeHeight);
  })();


  
</script>



{% endblock %}

</body>
</html>